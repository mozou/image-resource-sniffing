name: æ„å»ºAndroid APK (ç®€å•æ–¹æ¡ˆ)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç®€å•æ„å»ºAPK
      run: |
        # åˆ›å»ºæœ€ç®€å•çš„Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04

        ENV DEBIAN_FRONTEND=noninteractive
        ENV BUILDOZER_WARN_ON_ROOT=0

        RUN apt-get update && apt-get install -y \
            python3 python3-pip openjdk-8-jdk git unzip zip build-essential

        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

        RUN pip3 install buildozer==1.4.0 cython kivy requests

        WORKDIR /app
        COPY . /app/

        # ä½¿ç”¨yeså‘½ä»¤è‡ªåŠ¨å›ç­”ç¡®è®¤æç¤º
        CMD echo "y" | buildozer android debug
        EOF
        
        # æ„å»ºå¹¶è¿è¡Œ
        docker build -t simple-build .
        mkdir -p bin
        docker run --name simple-container -v $(pwd)/bin:/app/bin simple-build
        
        # æ£€æŸ¥ç»“æœ
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
          ls -la bin/
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          docker logs simple-container
        fi
        
        docker rm simple-container || true
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›¾ç‰‡èµ„æºå—…æ¢å·¥å…·-ç®€å•æ„å»º
        path: bin/*.apk
        retention-days: 30