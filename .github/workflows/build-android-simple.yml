name: 构建Android APK (简单方案)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 简单构建APK
      run: |
        # 创建最简单的Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04

        ENV DEBIAN_FRONTEND=noninteractive
        ENV BUILDOZER_WARN_ON_ROOT=0

        RUN apt-get update && apt-get install -y \
            python3 python3-pip openjdk-8-jdk git unzip zip build-essential

        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

        RUN pip3 install buildozer==1.4.0 cython kivy requests

        WORKDIR /app
        COPY . /app/

        # 使用yes命令自动回答确认提示
        CMD echo "y" | buildozer android debug
        EOF
        
        # 构建并运行
        docker build -t simple-build .
        mkdir -p bin
        docker run --name simple-container -v $(pwd)/bin:/app/bin simple-build
        
        # 检查结果
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "🎉 构建成功！"
          ls -la bin/
        else
          echo "❌ 构建失败"
          docker logs simple-container
        fi
        
        docker rm simple-container || true
        
    - name: 上传APK文件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 图片资源嗅探工具-简单构建
        path: bin/*.apk
        retention-days: 30