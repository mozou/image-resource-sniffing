name: æ„å»ºAndroid APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ„å»ºAPKä½¿ç”¨è‡ªå®šä¹‰Docker
      run: |
        # åˆ›å»ºè‡ªå®šä¹‰Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04

        # é¿å…äº¤äº’å¼å®‰è£…
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=Asia/Shanghai

        # å®‰è£…åŸºç¡€ä¾èµ–
        RUN apt-get update && apt-get install -y \
            python3 \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            unzip \
            zip \
            openjdk-8-jdk \
            wget \
            curl \
            sudo \
            && rm -rf /var/lib/apt/lists/*

        # åˆ›å»ºérootç”¨æˆ·
        RUN useradd -m -s /bin/bash builduser && \
            echo "builduser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

        # è®¾ç½®Javaç¯å¢ƒ
        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

        # å®‰è£…Pythonä¾èµ–
        RUN pip3 install --upgrade pip
        RUN pip3 install buildozer==1.4.0 cython==0.29.33 kivy==2.1.0 requests

        # åˆ‡æ¢åˆ°érootç”¨æˆ·
        USER builduser
        WORKDIR /home/builduser/app

        # å¤åˆ¶é¡¹ç›®æ–‡ä»¶
        COPY --chown=builduser:builduser . /home/builduser/app/

        # è®¾ç½®ç¯å¢ƒå˜é‡ç¦ç”¨buildozer rootè­¦å‘Š
        ENV BUILDOZER_WARN_ON_ROOT=0

        # æ„å»ºAPK
        CMD ["buildozer", "android", "debug"]
        EOF
        
        # æ„å»ºDockeré•œåƒ
        echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
        docker build -t image-sniffer-build .
        
        # åˆ›å»ºbinç›®å½•
        mkdir -p bin
        
        # è¿è¡Œå®¹å™¨æ„å»ºAPK
        echo "ğŸš€ å¼€å§‹æ„å»ºAPK..."
        docker run --name build-container \
          -v $(pwd)/bin:/home/builduser/app/bin \
          -e BUILDOZER_WARN_ON_ROOT=0 \
          image-sniffer-build
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
          ls -la bin/
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ£€æŸ¥å®¹å™¨æ—¥å¿—..."
          docker logs build-container
          exit 1
        fi
        
        # æ¸…ç†å®¹å™¨
        docker rm build-container || true
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›¾ç‰‡èµ„æºå—…æ¢å·¥å…·-debug
        path: bin/*.apk
        retention-days: 30
        
    - name: åˆ›å»ºRelease
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: å›¾ç‰‡èµ„æºå—…æ¢å·¥å…· v${{ github.run_number }}
        body: |
          ## ğŸ“± Android APK è‡ªåŠ¨æ„å»º
          
          è¿™æ˜¯é€šè¿‡GitHub Actionsè‡ªåŠ¨æ„å»ºçš„Android APKæ–‡ä»¶ã€‚
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - æ„å»ºç¼–å·: ${{ github.run_number }}
          
          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. å®‰è£…APKå¹¶æˆäºˆå¿…è¦æƒé™
          4. å¼€å§‹ä½¿ç”¨å›¾ç‰‡èµ„æºå—…æ¢åŠŸèƒ½
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - éœ€è¦Android 5.0+ï¼ˆAPI 21+ï¼‰
          - éœ€è¦ç½‘ç»œå’Œå­˜å‚¨æƒé™
          - å›¾ç‰‡ä¿å­˜åœ¨ä¸‹è½½ç›®å½•
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
