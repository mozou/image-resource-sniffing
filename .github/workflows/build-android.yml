name: 构建Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 构建APK使用Docker
      run: |
        # 创建Dockerfile
        cat > Dockerfile << 'EOF'
        FROM kivy/buildozer:latest

        # 设置工作目录
        WORKDIR /app

        # 复制项目文件
        COPY . /app/

        # 设置环境变量
        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        ENV ANDROID_HOME=/home/user/.buildozer/android/platform/android-sdk
        ENV ANDROID_SDK_ROOT=$ANDROID_HOME
        ENV PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools

        # 构建APK
        RUN buildozer android debug
        EOF
        
        # 构建Docker镜像并运行
        docker build -t image-sniffer-build .
        docker run --name build-container image-sniffer-build
        
        # 从容器中复制APK文件
        docker cp build-container:/app/bin ./bin
        
        # 清理容器
        docker rm build-container
        
    - name: 上传APK文件
      uses: actions/upload-artifact@v4
      with:
        name: 图片资源嗅探工具-debug
        path: bin/*.apk
        retention-days: 30
        
    - name: 创建Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: 图片资源嗅探工具 v${{ github.run_number }}
        body: |
          ## 📱 Android APK 自动构建
          
          这是通过GitHub Actions自动构建的Android APK文件。
          
          ### 📋 版本信息
          - 构建时间: ${{ github.event.head_commit.timestamp }}
          - 提交SHA: ${{ github.sha }}
          - 构建编号: ${{ github.run_number }}
          
          ### 📥 安装说明
          1. 下载下方的APK文件
          2. 在Android设备上启用"未知来源"应用安装
          3. 安装APK并授予必要权限
          4. 开始使用图片资源嗅探功能
          
          ### ⚠️ 注意事项
          - 需要Android 5.0+（API 21+）
          - 需要网络和存储权限
          - 图片保存在下载目录
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}