name: æž„å»ºAndroid APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æž„å»ºAPKä½¿ç”¨è‡ªå®šä¹‰Docker
      run: |
        # åˆ›å»ºè‡ªå®šä¹‰Dockerfile
        cat > Dockerfile << 'EOF'
        FROM ubuntu:20.04

        # é¿å…äº¤äº’å¼å®‰è£…
        ENV DEBIAN_FRONTEND=noninteractive
        ENV TZ=Asia/Shanghai

        # å®‰è£…åŸºç¡€ä¾èµ–
        RUN apt-get update && apt-get install -y \
            python3 \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            unzip \
            zip \
            openjdk-8-jdk \
            wget \
            curl \
            && rm -rf /var/lib/apt/lists/*

        # è®¾ç½®JavaçŽ¯å¢ƒ
        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64

        # å®‰è£…Pythonä¾èµ–
        RUN pip3 install --upgrade pip
        RUN pip3 install buildozer==1.4.0 cython==0.29.33 kivy==2.1.0 requests

        # åˆ›å»ºå·¥ä½œç›®å½•
        WORKDIR /app

        # å¤åˆ¶é¡¹ç›®æ–‡ä»¶
        COPY . /app/

        # è®¾ç½®æƒé™
        RUN chmod -R 755 /app

        # æž„å»ºAPK
        CMD ["buildozer", "android", "debug"]
        EOF
        
        # æž„å»ºDockeré•œåƒ
        echo "ðŸ”¨ æž„å»ºDockeré•œåƒ..."
        docker build -t image-sniffer-build .
        
        # è¿è¡Œå®¹å™¨æž„å»ºAPK
        echo "ðŸš€ å¼€å§‹æž„å»ºAPK..."
        docker run --name build-container -v $(pwd)/bin:/app/bin image-sniffer-build
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        if [ -f "bin/*.apk" ]; then
          echo "ðŸŽ‰ æž„å»ºæˆåŠŸï¼"
          ls -la bin/
        else
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œæ£€æŸ¥å®¹å™¨æ—¥å¿—..."
          docker logs build-container
        fi
        
        # æ¸…ç†å®¹å™¨
        docker rm build-container || true
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: å›¾ç‰‡èµ„æºå—…æŽ¢å·¥å…·-debug
        path: bin/*.apk
        retention-days: 30
        
    - name: åˆ›å»ºRelease
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: å›¾ç‰‡èµ„æºå—…æŽ¢å·¥å…· v${{ github.run_number }}
        body: |
          ## ðŸ“± Android APK è‡ªåŠ¨æž„å»º
          
          è¿™æ˜¯é€šè¿‡GitHub Actionsè‡ªåŠ¨æž„å»ºçš„Android APKæ–‡ä»¶ã€‚
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - æž„å»ºç¼–å·: ${{ github.run_number }}
          
          ### ðŸ“¥ å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. å®‰è£…APKå¹¶æŽˆäºˆå¿…è¦æƒé™
          4. å¼€å§‹ä½¿ç”¨å›¾ç‰‡èµ„æºå—…æŽ¢åŠŸèƒ½
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - éœ€è¦Android 5.0+ï¼ˆAPI 21+ï¼‰
          - éœ€è¦ç½‘ç»œå’Œå­˜å‚¨æƒé™
          - å›¾ç‰‡ä¿å­˜åœ¨ä¸‹è½½ç›®å½•
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
