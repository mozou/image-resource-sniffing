name: æž„å»ºAndroid APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æž„å»ºAPKä½¿ç”¨Docker
      run: |
        # åˆ›å»ºDockerfile
        cat > Dockerfile << 'EOF'
        FROM kivy/buildozer:latest

        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /app

        # å¤åˆ¶é¡¹ç›®æ–‡ä»¶
        COPY . /app/

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        ENV ANDROID_HOME=/home/user/.buildozer/android/platform/android-sdk
        ENV ANDROID_SDK_ROOT=$ANDROID_HOME
        ENV PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools

        # æž„å»ºAPK
        RUN buildozer android debug
        EOF
        
        # æž„å»ºDockeré•œåƒå¹¶è¿è¡Œ
        docker build -t image-sniffer-build .
        docker run --name build-container image-sniffer-build
        
        # ä»Žå®¹å™¨ä¸­å¤åˆ¶APKæ–‡ä»¶
        docker cp build-container:/app/bin ./bin
        
        # æ¸…ç†å®¹å™¨
        docker rm build-container
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: å›¾ç‰‡èµ„æºå—…æŽ¢å·¥å…·-debug
        path: bin/*.apk
        retention-days: 30
        
    - name: åˆ›å»ºRelease
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: å›¾ç‰‡èµ„æºå—…æŽ¢å·¥å…· v${{ github.run_number }}
        body: |
          ## ðŸ“± Android APK è‡ªåŠ¨æž„å»º
          
          è¿™æ˜¯é€šè¿‡GitHub Actionsè‡ªåŠ¨æž„å»ºçš„Android APKæ–‡ä»¶ã€‚
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
          - æž„å»ºç¼–å·: ${{ github.run_number }}
          
          ### ðŸ“¥ å®‰è£…è¯´æ˜Ž
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. å®‰è£…APKå¹¶æŽˆäºˆå¿…è¦æƒé™
          4. å¼€å§‹ä½¿ç”¨å›¾ç‰‡èµ„æºå—…æŽ¢åŠŸèƒ½
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - éœ€è¦Android 5.0+ï¼ˆAPI 21+ï¼‰
          - éœ€è¦ç½‘ç»œå’Œå­˜å‚¨æƒé™
          - å›¾ç‰‡ä¿å­˜åœ¨ä¸‹è½½ç›®å½•
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}