name: 构建Android APK (最终方案)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-20.04
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: 安装依赖
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq openjdk-8-jdk unzip
        python -m pip install --upgrade pip -q
        pip install buildozer==1.4.0 cython==0.29.33 -q
        pip install kivy==2.1.0 requests -q
        
    - name: 设置环境变量
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
        echo "BUILDOZER_WARN_ON_ROOT=0" >> $GITHUB_ENV
        
    - name: 构建APK
      run: |
        # 创建简化的buildozer.spec
        cat > buildozer.spec << 'EOF'
        [app]
        title = ImageSniffer
        package.name = imagesniffer
        package.domain = org.example
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy,requests
        orientation = portrait
        fullscreen = 0
        android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
        android.api = 28
        android.minapi = 21
        android.ndk = 20b
        android.archs = armeabi-v7a
        
        [buildozer]
        log_level = 1
        warn_on_root = 0
        EOF
        
        # 构建APK，重定向输出减少刷屏
        echo "开始构建APK..."
        buildozer android debug > build.log 2>&1 || {
          echo "构建失败，显示最后50行日志:"
          tail -50 build.log
          exit 1
        }
        
        echo "构建完成！"
        ls -la bin/
        
    - name: 上传APK文件
      uses: actions/upload-artifact@v4
      with:
        name: 图片资源嗅探工具-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: 构建日志
        path: build.log
        retention-days: 7
        
    - name: 创建Release
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: 图片资源嗅探工具 v${{ github.run_number }}
        body: |
          ## 📱 Android APK 自动构建
          
          **版本**: v${{ github.run_number }}  
          **构建时间**: ${{ github.event.head_commit.timestamp }}  
          **提交**: ${{ github.sha }}
          
          ### 📥 安装说明
          1. 下载APK文件
          2. 在Android设备上启用"未知来源"
          3. 安装并授予权限
          
          ### 📋 系统要求
          - Android 5.0+ (API 21+)
          - 网络和存储权限
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}