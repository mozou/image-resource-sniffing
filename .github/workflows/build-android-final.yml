name: æ„å»ºAndroid APK (æœ€ç»ˆæ–¹æ¡ˆ)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-20.04
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq openjdk-8-jdk unzip
        python -m pip install --upgrade pip -q
        pip install buildozer==1.4.0 cython==0.29.33 -q
        pip install kivy==2.1.0 requests -q
        
    - name: è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
        echo "BUILDOZER_WARN_ON_ROOT=0" >> $GITHUB_ENV
        
    - name: æ„å»ºAPK
      run: |
        # åˆ›å»ºç®€åŒ–çš„buildozer.spec
        cat > buildozer.spec << 'EOF'
        [app]
        title = ImageSniffer
        package.name = imagesniffer
        package.domain = org.example
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy,requests
        orientation = portrait
        fullscreen = 0
        android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
        android.api = 28
        android.minapi = 21
        android.ndk = 20b
        android.archs = armeabi-v7a
        
        [buildozer]
        log_level = 1
        warn_on_root = 0
        EOF
        
        # æ„å»ºAPKï¼Œé‡å®šå‘è¾“å‡ºå‡å°‘åˆ·å±
        echo "å¼€å§‹æ„å»ºAPK..."
        buildozer android debug > build.log 2>&1 || {
          echo "æ„å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºæœ€å50è¡Œæ—¥å¿—:"
          tail -50 build.log
          exit 1
        }
        
        echo "æ„å»ºå®Œæˆï¼"
        ls -la bin/
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: å›¾ç‰‡èµ„æºå—…æ¢å·¥å…·-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: æ„å»ºæ—¥å¿—
        path: build.log
        retention-days: 7
        
    - name: åˆ›å»ºRelease
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: å›¾ç‰‡èµ„æºå—…æ¢å·¥å…· v${{ github.run_number }}
        body: |
          ## ğŸ“± Android APK è‡ªåŠ¨æ„å»º
          
          **ç‰ˆæœ¬**: v${{ github.run_number }}  
          **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}  
          **æäº¤**: ${{ github.sha }}
          
          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"
          3. å®‰è£…å¹¶æˆäºˆæƒé™
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Android 5.0+ (API 21+)
          - ç½‘ç»œå’Œå­˜å‚¨æƒé™
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}